<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öõÔ∏è</text></svg>">
    <title>Tom Shi</title>
    
    <!-- ÂºïÂÖ• Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- ÂºïÂÖ• Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ÂºïÂÖ• Globe.gl -->
    <script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
    <!-- ÂºïÂÖ• Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1d1d1f;
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --accent-blue: #2997ff;
            --accent-purple: #bf5af2;
            --accent-green: #30d158;
            --accent-red: #ff3b30;
            --font-stack: "SF Pro Display", -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-stack);
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, #2a2a2e 0%, #000000 80%);
            min-height: 100vh;
        }

        /* Nav */
        nav {
            position: sticky; top: 0; left: 0; width: 100%; height: 52px;
            background: rgba(29, 29, 31, 0.72); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 999; display: flex; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .nav-content { width: 980px; max-width: 92%; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .nav-logo { font-weight: 600; color: #fff; text-decoration: none; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-item { color: #e8e8ed; text-decoration: none; opacity: 0.8; transition: 0.3s; cursor: pointer; }
        .nav-item:hover { opacity: 1; color: var(--accent-blue); }
        .lang-btn { font-size: 14px; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .lang-btn:hover { background: rgba(255,255,255,0.2); }

        .container { width: 980px; max-width: 90%; margin: 0 auto; }

        /* Hero */
        .hero { padding: 140px 0 100px; text-align: center; }
        h1 { font-size: 64px; font-weight: 700; line-height: 1.05; letter-spacing: -0.015em; margin-bottom: 24px; background: linear-gradient(135deg, #ffffff 0%, #a1a1a6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-desc { font-size: 24px; line-height: 1.4; color: var(--text-secondary); max-width: 640px; margin: 0 auto 40px; }

        /* Bento Grid */
        .bento-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 80px; }
        .tile { background: var(--card-bg); border-radius: 28px; padding: 35px; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); min-height: 420px; }
        .tile:hover { transform: scale(1.02); z-index: 2; box-shadow: 0 30px 60px rgba(0,0,0,0.4); }
        .tile-large { grid-column: span 2; }
        .tile-small { grid-column: span 1; }
        .tile-subtitle { font-size: 11px; font-weight: 600; color: #86868b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; position: relative; z-index: 2; }
        .tile-title { font-size: 32px; font-weight: 600; color: #f5f5f7; line-height: 1.1; margin-bottom: 15px; position: relative; z-index: 2; }
        .tile-text { font-size: 17px; color: #86868b; line-height: 1.6; font-weight: 400; white-space: pre-line; position: relative; z-index: 2; }

        /* --- Globe Card --- */
        #earth-card { padding: 0; background: #000; border: 1px solid #333; overflow: hidden; }
        .earth-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; border-radius: 28px; }
        
        .hud-container { position: absolute; top: 20px; left: 20px; z-index: 5; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .hud-pill {
            background: rgba(20, 20, 20, 0.75); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 20px;
            display: flex; align-items: center; gap: 8px; width: fit-content; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transform: translateX(-10px); opacity: 0; animation: slideIn 0.5s ease forwards;
        }
        .hud-pill:nth-child(2) { animation-delay: 0.1s; }
        @keyframes slideIn { to { transform: translateX(0); opacity: 1; } }

        .hud-icon { color: var(--accent-green); font-size: 12px; }
        .hud-text { font-size: 12px; color: #fff; font-weight: 500; letter-spacing: 0.5px; }
        .live-dot { width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; box-shadow: 0 0 8px var(--accent-green); animation: pulse 2s infinite; }

        .earth-stats { position: absolute; bottom: 30px; left: 30px; z-index: 5; pointer-events: none; }
        .counter-num { font-size: 48px; font-weight: 700; color: #fff; letter-spacing: -1px; font-variant-numeric: tabular-nums; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }

        /* Quantum Box */
        .quantum-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .box-icon { font-size: 48px; transition: 0.3s; filter: drop-shadow(0 0 10px rgba(191,90,242,0.3)); }
        .quantum-result { margin-top: 20px; font-size: 15px; color: #e8e8ed; text-align: center; opacity: 0; transition: 0.5s; font-weight: 500; }
        .tile:hover .box-icon { transform: scale(1.1) rotate(5deg); }
        .box-icon.open { transform: scale(0.8); opacity: 0; }

        /* Contact & Message */
        .contact-list { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; z-index: 2; }
        .contact-btn { display: flex; align-items: center; justify-content: center; height: 50px; background: rgba(255,255,255,0.08); border-radius: 12px; color: #fff; text-decoration: none; font-size: 15px; font-weight: 500; transition: 0.2s; }
        .contact-btn:hover { background: #fff; color: #000; }

        .message-section { padding: 80px 0; background: #121212; border-radius: 32px; margin-bottom: 50px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .ios-input-group { position: relative; width: 100%; max-width: 520px; margin: 30px auto; }
        .ios-input { width: 100%; background: #252527; border: 1px solid #3a3a3c; padding: 18px 24px; padding-right: 90px; border-radius: 24px; color: white; font-size: 17px; outline: none; transition: 0.3s; }
        .ios-input:focus { border-color: var(--accent-blue); background: #2c2c2e; }
        .ios-send-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; background: var(--accent-blue); border-radius: 50%; border: none; color: white; cursor: pointer; transition: 0.2s; z-index: 2; }
        .ios-send-btn:hover { transform: translateY(-50%) scale(1.05); }
        .ios-ai-btn { position: absolute; right: 52px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; background: transparent; border-radius: 50%; border: none; color: var(--accent-purple); font-size: 18px; cursor: pointer; z-index: 2; }
        .ios-ai-btn:hover { background: rgba(191, 90, 242, 0.1); }
        .ios-ai-btn.loading { animation: spin 1s infinite; opacity: 0.7; pointer-events: none; }
        .message-list { max-width: 520px; margin: 0 auto; text-align: left; display: flex; flex-direction: column; gap: 16px; }
        .msg-bubble { background: #252527; padding: 14px 20px; border-radius: 20px; border-bottom-left-radius: 4px; color: #f5f5f7; font-size: 16px; line-height: 1.4; align-self: flex-start; max-width: 90%; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Floating Chat */
        .fab-ai { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: rgba(29, 29, 31, 0.8); backdrop-filter: blur(20px); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 1000; transition: all 0.3s; color: var(--accent-purple); }
        .fab-ai:hover { transform: scale(1.1) rotate(15deg); border-color: var(--accent-purple); color: white; background: var(--accent-purple); }
        .fab-icon { font-size: 24px; }
        .chat-modal { position: fixed; bottom: 100px; right: 30px; width: 380px; height: 550px; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(40px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 40px 80px rgba(0,0,0,0.6); display: flex; flex-direction: column; z-index: 999; opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .chat-modal.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
        .chat-modal.fullscreen { width: 100% !important; height: 100% !important; bottom: 0 !important; right: 0 !important; border-radius: 0; border: none; z-index: 2000; }
        .chat-header { padding: 18px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; justify-content: space-between; align-items: center; }
        .chat-title { font-weight: 600; font-size: 16px; color: #fff; display: flex; align-items: center; gap: 8px; }
        .chat-controls { display: flex; gap: 15px; align-items: center; }
        .chat-btn { cursor: pointer; color: #86868b; transition: 0.2s; font-size: 16px; display: flex; align-items: center; }
        .chat-btn:hover { color: #fff; }
        .chat-body { flex: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; scroll-behavior: smooth; }
        .chat-bubble { padding: 14px 18px; border-radius: 20px; font-size: 15px; line-height: 1.5; max-width: 85%; }
        .chat-bubble.user { background: var(--accent-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-bubble.ai { background: #3a3a3c; color: #f5f5f7; align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 18px 24px; border-top: 1px solid rgba(255,255,255,0.08); display: flex; gap: 12px; background: rgba(0,0,0,0.2); }
        .chat-input { flex: 1; background: #1c1c1e; border: 1px solid rgba(255,255,255,0.1); padding: 12px 18px; border-radius: 24px; color: white; outline: none; font-size: 15px; }
        .chat-send { background: var(--accent-purple); color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; justify-content: center; align-items: center; }
        
        /* Thinking Indicator */
        .thinking-dots { display: inline-flex; gap: 4px; align-items: center; height: 20px; }
        .thinking-dots span { width: 6px; height: 6px; background: #86868b; border-radius: 50%; animation: blink 1.4s infinite both; }
        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        footer { padding: 40px 0; text-align: center; color: #6e6e73; font-size: 12px; }
        
        @media (max-width: 768px) {
            h1 { font-size: 40px; }
            .bento-grid { grid-template-columns: 1fr; }
            .tile-large, .tile-small { grid-column: span 1; }
            .tile { min-height: 300px; height: auto; }
            .chat-modal { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; }
            
            /* ÊâãÊú∫Á´ØÊâìÂºÄËÅäÂ§©Êó∂ÔºåÈöêËóèÊµÆÂä®ÊåâÈíÆ (Èò≤Ê≠¢ÈÅÆÊå°ÂèëÈÄÅÈîÆ) */
            .fab-ai.active { opacity: 0; pointer-events: none; transform: scale(0.8); }
        }
    </style>
</head>
<body>

    <nav>
        <div class="nav-content">
            <a href="#" class="nav-logo">Tom Shi</a>
            <div class="nav-links">
                <a href="#about" class="nav-item" data-i18n="nav_about">About</a>
                <a href="#contact" class="nav-item" data-i18n="nav_contact">Contact</a>
                <div class="lang-btn" onclick="toggleLanguage()">üåè</div>
            </div>
        </div>
    </nav>

    <div class="container">
        <section class="hero">
            <h1 class="gsap-hero">Tom Shi.</h1>
            <p class="hero-desc gsap-hero" data-i18n="hero_desc">
                Developer. Thinker. Explorer.
            </p>
        </section>

        <div id="about" class="bento-grid">
            
            <!-- 1. Profile -->
            <div class="tile tile-large scroll-fade">
                <div>
                    <div class="tile-subtitle">Profile</div>
                    <div class="tile-title" data-i18n="profile_title">Tough Journey #1 (Li Bai).</div>
                    <div class="tile-text" data-i18n="profile_text">
                        Clear wine from gilded bottle is worth ten thousand coins.
                        Delicious dishes in jade platters are precious and expensive.
                        I halt my chopsticks and could not continue to keep dining.
                        In taking out my sword, I look around at blank and feel lost.
                        The road is tough, it‚Äôs very tough.
                        The time will come when I can ride across on the waves,
                        and then I can hoist the sails and get across the grayish sea.
                    </div>
                </div>
            </div>

            <!-- 2. Globe + Stats -->
            <div class="tile tile-small scroll-fade" id="earth-card">
                <!-- HUD Overlay -->
                <div class="hud-container">
                    <div class="hud-pill">
                        <div class="live-dot"></div>
                        <span class="hud-text" id="user-ip">Scanning...</span>
                    </div>
                    <div class="hud-pill">
                        <i class="bi bi-geo-alt-fill hud-icon"></i>
                        <span class="hud-text" id="user-location">Locating...</span>
                    </div>
                    <div class="hud-pill" id="ai-status-pill" style="opacity:0; transition:opacity 0.5s;">
                        <i class="bi bi-cpu-fill hud-icon" style="color: var(--accent-purple);"></i>
                        <span class="hud-text" id="ai-model-name">AI Loading...</span>
                    </div>
                </div>
                
                <!-- Globe Container -->
                <div class="earth-container" id="globeViz"></div>
                
                <div class="earth-stats">
                    <div class="live-indicator" style="margin-bottom: 0;">
                        <span data-i18n="stats_title" style="color: #888; font-weight: 500;">Observers</span>
                    </div>
                    <div class="counter-num" id="visit-count">----</div>
                </div>
            </div>

            <!-- 3. Schr√∂dinger's Box -->
            <div class="tile tile-small scroll-fade" onclick="openQuantumBox()">
                <div class="tile-subtitle">Experiment</div>
                <div class="tile-title" data-i18n="quantum_title">Schr√∂dinger's Box</div>
                <div class="quantum-box">
                    <div class="box-icon">üì¶</div>
                    <div class="quantum-result" id="quantum-result" data-i18n="quantum_hint">Click to observe</div>
                </div>
            </div>

            <!-- 4. Contact -->
            <div class="tile tile-large scroll-fade" id="contact" style="background: linear-gradient(135deg, #1d1d1f 0%, #2c2c2e 100%);">
                <div>
                    <div class="tile-subtitle">Connect</div>
                    <div class="tile-title" data-i18n="connect_title">Get in Touch.</div>
                    <div class="tile-text" data-i18n="connect_text">Open to collaborations.</div>
                </div>
                <div class="contact-list">
                    <a href="https://tomshi.online" target="_blank" class="contact-btn" data-i18n="btn_website">Website ‚Üó</a>
                    <a href="mailto:tom11s@outlook.com" class="contact-btn" data-i18n="btn_email">Email ‚Üó</a>
                    <a href="https://www.instagram.com/tom.11s?igsh=MW5sb2VuajlkMzY3Nw==" target="_blank" class="contact-btn" data-i18n="btn_ins">Instagram ‚Üó</a>
                    <a href="#" class="contact-btn" style="opacity: 0.5; cursor: default;" data-i18n="btn_more">More...</a>
                </div>
            </div>
        </div>

        <!-- Message Board -->
        <div id="board" class="message-section scroll-fade">
            <h2 style="font-size: 32px; font-weight: 600; margin-bottom: 10px; color: #f5f5f7;" data-i18n="msg_title">Message Board</h2>
            <p style="color: #86868b; margin-bottom: 30px;" data-i18n="msg_desc">Leave a note. It stays in the cloud.</p>
            <div class="ios-input-group">
                <input type="text" id="msg-input" class="ios-input" placeholder="Type a message..." onkeypress="if(event.keyCode==13) sendMsg()">
                <button class="ios-ai-btn" onclick="generateAIMessage()" title="AI Assistant">‚ú®</button>
                <button class="ios-send-btn" onclick="sendMsg()">‚Üë</button>
            </div>
            <div id="msg-list" class="message-list">
                <div style="text-align: center; color: #444;" data-i18n="loading">Loading...</div>
            </div>
        </div>

        <footer>Copyright ¬© <span id="year"></span> Tom Shi. All rights reserved.</footer>
    </div>

    <!-- Floating Chat -->
    <div class="fab-ai" onclick="toggleChat()"><i class="bi bi-stars fab-icon"></i></div>
    <div class="chat-modal" id="chat-modal">
        <div class="chat-header">
            <div class="chat-title"><i class="bi bi-robot" style="color: #bf5af2;"></i> Ask Tom AI</div>
            <div class="chat-controls">
                <div class="chat-btn" onclick="toggleFullscreen()"><i class="bi bi-arrows-fullscreen"></i></div>
                <div class="chat-btn" onclick="toggleChat()"><i class="bi bi-x-lg"></i></div>
            </div>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="chat-bubble ai" data-i18n="ai_welcome">Hello! I am Tom's digital twin. Ask me anything.</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask something..." onkeypress="if(event.keyCode==13) sendAIChat()">
            <button class="chat-send" onclick="sendAIChat()"><i class="bi bi-arrow-up-short"></i></button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <script>
        // --- Ê†∏ÂøÉÈÖçÁΩÆÂå∫ (CONFIG) ---
        // „ÄêÂÆâÂÖ®ÊèêÁ§∫„Äë
        // 1. Supabase Key: ÊòØÂÖ¨ÂºÄÁöÑ (Publishable)ÔºåËØ∑Á°Æ‰øùÂú® Supabase ÂêéÂè∞ÂºÄÂêØ RLS (Row Level Security) Á≠ñÁï•‰ª•‰øùÊä§Êï∞ÊçÆ„ÄÇ
        // 2. Gemini Key: Â∑≤Âú® Google Cloud Console ËÆæÁΩÆÂüüÂêçÈôêÂà∂ (tomshi.online)Ôºå‰ªÖÈôêÊú¨Á´ô‰ΩøÁî®ÔºåÁõ∏ÂØπÂÆâÂÖ®„ÄÇ
        // 3. SiliconFlow Key: ‚ö†Ô∏è ÁõÆÂâçÊö¥Èú≤Âú®ÂâçÁ´Ø„ÄÇÂª∫ËÆÆ‰ªÖ‰ΩøÁî®ÂÖçË¥π/Â∞èÈ¢ùË¥¶Êà∑ÔºåÊàñÈÄöËøáÂêéÁ´Ø‰ª£ÁêÜ (Â¶Ç Cloudflare Worker) ÈöêËóèÊ≠§ Key„ÄÇ
        
        const CONFIG = {
            url: 'https://fznfneqwxzuwtognuoeo.supabase.co',
            key: 'sb_publishable_UlNMDLt4OaYIX-_lCezGwA_8jIQLhFO',
            
            // È¢ÑËÆæÈÖçÁΩÆÂ∫ì
            profiles: {
                gemini: {
                    provider: 'gemini',
                    name: 'Gemini (Google)',
                    key: 'AIzaSyC9j7AL5vtuyEHfu5V69nVcyjVGZ5uHcUA', 
                    url: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent',
                    model: ''
                },
                siliconflow: {
                    provider: 'openai', 
                    name: 'Qwen 2.5 (CN)',
                    // ‚ö†Ô∏è Ê≥®ÊÑèÔºöÊ≠§ Key ‰∏∫ Bearer TokenÔºåÂ∞ΩÈáè‰∏çË¶ÅÂú®ÂÖ¨ÂÖ± GitHub ‰ªìÂ∫ì‰∏≠ÈïøÊúüÊö¥Èú≤È´òÈ¢ùÂ∫¶Ë¥¶Êà∑ÁöÑ Key
                    key: 'sk-lsjnmtotknlkcsqftmaznqcksfpzeuamuoodrwldbcersxal',
                    url: 'https://api.siliconflow.cn/v1/chat/completions',
                    model: 'Qwen/Qwen2.5-7B-Instruct' 
                }
            },
            
            // ÂΩìÂâçÊøÄÊ¥ªÁöÑÈÖçÁΩÆ (ÂàùÂßãÂåñ‰∏∫Á©∫ÔºåÂä†ËΩΩÂêéËá™Âä®Â°´ÂÖÖ)
            active: null 
        };

        const i18n = {
            en: {
                nav_about: "About", nav_contact: "Contact", nav_msg: "Messages", hero_desc: "Developer. Thinker. Explorer.",
                profile_title: "Tough Journey #1 (Li Bai).", profile_text: "Clear wine from gilded bottle is worth ten thousand coins.\nDelicious dishes in jade platters are precious and expensive.\nI halt my chopsticks and could not continue to keep dining.\nIn taking out my sword, I look around at blank and feel lost.\nMy desire to cross Yellow River is stopped by frozen water.\nAn attempt to go up Mount Taihang is frustrated by snow.\nIn my leisure time, I go fishing on shore in greenish water.\nSuddenly I‚Äôm dreaming while riding a boat sailing near sun.\nThe road is tough, it‚Äôs very tough.\nIt branches out into many other paths. Where am I now?\nThe time will come when I can ride across on the waves,\nand then I can hoist the sails and get across the grayish sea.",
                stats_title: "Observers", quantum_title: "Schr√∂dinger's Box", quantum_hint: "Click to observe",
                connect_title: "Get in Touch.", connect_text: "Open to collaborations.",
                msg_title: "Message Board", msg_desc: "Leave a note. It stays in the cloud.", loading: "Loading...", no_msg: "No messages yet.",
                db_error: "(Database not connected)", send_fail: "Send failed.", input_ph: "Type a message...", 
                btn_website: "Website ‚Üó", btn_email: "Email ‚Üó", btn_ins: "Instagram ‚Üó", btn_more: "More...",
                ai_welcome: "Hello! I am Tom's digital twin. Ask me anything."
            },
            zh: {
                nav_about: "ÂÖ≥‰∫é", nav_contact: "ËÅîÁ≥ª", nav_msg: "ÁïôË®Ä", hero_desc: "ÂºÄÂèëËÄÖ ¬∑ ÊÄùËÄÉËÄÖ ¬∑ Êé¢Á¥¢ËÄÖ",
                profile_title: "Ë°åË∑ØÈöæ¬∑ÂÖ∂‰∏Ä", profile_text: "ÈáëÊ®ΩÊ∏ÖÈÖíÊñóÂçÅÂçÉÔºåÁéâÁõòÁèçÁæûÁõ¥‰∏áÈí±„ÄÇ\nÂÅúÊùØÊäïÁÆ∏‰∏çËÉΩÈ£üÔºåÊãîÂâëÂõõÈ°æÂøÉËå´ÁÑ∂„ÄÇ\nÊ¨≤Ê∏°ÈªÑÊ≤≥ÂÜ∞Â°ûÂ∑ùÔºåÂ∞ÜÁôªÂ§™Ë°åÈõ™Êª°Â±±„ÄÇ\nÈó≤Êù•ÂûÇÈíìÁ¢ßÊ∫™‰∏äÔºåÂøΩÂ§ç‰πòËàüÊ¢¶Êó•Ëæπ„ÄÇ\nË°åË∑ØÈöæÔºåË°åË∑ØÈöæÔºåÂ§öÊ≠ßË∑ØÔºå‰ªäÂÆâÂú®Ôºü\nÈïøÈ£éÁ†¥Êµ™‰ºöÊúâÊó∂ÔºåÁõ¥ÊåÇ‰∫ëÂ∏ÜÊµéÊ≤ßÊµ∑„ÄÇ",
                stats_title: "ËÆøÂÆ¢ËßÇÊµã", quantum_title: "ËñõÂÆöË∞îÁöÑÁõ≤Áõí", quantum_hint: "ÁÇπÂáªËøõË°åËßÇÊµã",
                connect_title: "‰øùÊåÅËÅîÁªú„ÄÇ", connect_text: "ÈöèÊó∂Ê¨¢Ëøé‰∫§ÊµÅ„ÄÇ",
                msg_title: "ÁïôË®ÄÊùø", msg_desc: "‰Ω†ÁöÑÂ£∞Èü≥Ôºå‰∫ëÁ´ØÊ∞∏Â≠ò„ÄÇ", loading: "Ê≠£Âú®Âä†ËΩΩ...", no_msg: "ÊöÇÊó†ÁïôË®ÄÔºåÊä¢‰∏™Ê≤ôÂèëÔºü", 
                db_error: "(ÊöÇÊú™ËøûÊé•Êï∞ÊçÆÂ∫ì)", send_fail: "ÂèëÈÄÅÂ§±Ë¥•„ÄÇ",
                input_ph: "ÂÜô‰∏ã‰Ω†ÁöÑÊÉ≥Ê≥ï...", 
                btn_website: "‰∏™‰∫∫ÁΩëÁ´ô ‚Üó", btn_email: "ÁîµÂ≠êÈÇÆÁÆ± ‚Üó", btn_ins: "Instagram ‚Üó", btn_more: "Êõ¥Â§ö...",
                ai_welcome: "‰Ω†Â•ΩÔºÅÊàëÊòØ Tom ÁöÑÊï∞Â≠óÂàÜË∫´„ÄÇ‰Ω†ÂèØ‰ª•ÈóÆÊàë‰ªª‰Ωï‰∫ã„ÄÇ"
            }
        };

        let currentLang = 'en';
        let sb = null;
        // Shared location data cache
        let cachedLocationData = null;

        // --- ÊâãÂä®Âú∞ÁêÜÂùêÊ†áË°•ÂÖ®Â∫ì (‰øÆÂ§çÂéÜÂè≤Êï∞ÊçÆÊó†ÂùêÊ†áÁöÑÈóÆÈ¢ò) ---
        const CITY_COORDINATES = {
            "Zhengzhou": { lat: 34.7466, lng: 113.6253 },
            "Beijing": { lat: 39.9042, lng: 116.4074 },
            "Shanghai": { lat: 31.2304, lng: 121.4737 },
            "Guangzhou": { lat: 23.1291, lng: 113.2644 },
            "Shenzhen": { lat: 22.5431, lng: 114.0579 },
            "Hong Kong": { lat: 22.3193, lng: 114.1694 },
            "Singapore": { lat: 1.3521, lng: 103.8198 },
            "Tokyo": { lat: 35.6762, lng: 139.6503 },
            "New York": { lat: 40.7128, lng: -74.0060 },
            "San Francisco": { lat: 37.7749, lng: -122.4194 },
            "London": { lat: 51.5074, lng: -0.1278 },
            "Chengdu": { lat: 30.5728, lng: 104.0668 },
            "Wuhan": { lat: 30.5928, lng: 114.3055 },
            "Hangzhou": { lat: 30.2741, lng: 120.1551 }
        };

        function initSupabase() { if (!CONFIG.url || CONFIG.url.includes('‰Ω†ÁöÑURL')) return null; try { return supabase.createClient(CONFIG.url, CONFIG.key); } catch (e) { return null; } }
        function detectLanguage() { const userLang = navigator.language || navigator.userLanguage; if (userLang.startsWith('zh')) setLanguage('zh'); else setLanguage('en'); }
        function toggleLanguage() { setLanguage(currentLang === 'en' ? 'zh' : 'en'); }
        function setLanguage(lang) {
            currentLang = lang; const content = i18n[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (content[key]) el.innerText = content[key]; });
            const input = document.getElementById('msg-input'); if (input) input.placeholder = content.input_ph;
            if (!sb) { const list = document.getElementById('msg-list'); if (list) list.innerHTML = `<div style="text-align: center; color: #444; font-size: 13px;">${content.db_error}</div>`; }
        }

        window.onload = async () => {
            detectLanguage(); 
            initAnimations(); 
            sb = initSupabase();
            
            // ÈªòËÆ§ËÆæÁΩÆ‰∏∫Á°ÖÂü∫ÊµÅÂä®Ôºà‰øùÂ∫ïÁ≠ñÁï•ÔºâÔºå‰ª•Èò≤ IP Ëé∑ÂèñÂ§™ÊÖ¢
            CONFIG.active = CONFIG.profiles.siliconflow;
            updateAIStatusUI();

            // Parallel execution for speed
            if (sb) {
                initStats();
                loadMessages();
                
                // First init globe, then log visitor (using cached data if available)
                // Globe initialization will also trigger the AI Auto-Switch
                await initGlobe();
                logVisitor(); 
            } else { 
                setLanguage(currentLang); 
            }
        };

        // --- UI Helper: ÊòæÁ§∫ÂΩìÂâç‰ΩøÁî®ÁöÑ AI Ê®°Âûã ---
        function updateAIStatusUI() {
            const el = document.getElementById('ai-model-name');
            const pill = document.getElementById('ai-status-pill');
            if (CONFIG.active) {
                el.innerText = CONFIG.active.name;
                pill.style.opacity = 1;
            }
        }

        // --- CORE: Robust Location Fetcher (Fetch -> JSONP Fallback) ---
        async function fetchLocationData() {
            if (cachedLocationData) return cachedLocationData;

            // 1. Helper: Geocode missing lat/lng using City Name
            const geocodeCity = async (city, country) => {
                try {
                    const query = country === 'Earth' ? city : `${city},${country}`;
                    const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`);
                    const geoData = await geoRes.json();
                    if(geoData && geoData.length > 0) {
                        return { lat: parseFloat(geoData[0].lat), lng: parseFloat(geoData[0].lon) };
                    }
                } catch(e) { console.log("Geocoding failed for:", city); }
                return null;
            };

            const fetchWithTimeout = (url, ms) => {
                const controller = new AbortController();
                const promise = fetch(url, { signal: controller.signal });
                const timeout = setTimeout(() => controller.abort(), ms);
                return promise.finally(() => clearTimeout(timeout));
            };

            const getBrowserLocation = () => {
                try {
                    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    if (tz) {
                        const parts = tz.split('/');
                        const city = parts[parts.length - 1].replace('_', ' ');
                        return { city: city, country: "Earth", region: "Unknown", countryCode: "XX" };
                    }
                } catch (e) {}
                return { city: "Unknown", country: "Earth", countryCode: "XX" };
            };

            // NEW: JSONP Implementation (The "Nuclear Option" for CORS)
            const fetchIpJsonp = () => {
                return new Promise((resolve, reject) => {
                    const callbackName = 'ip_callback_' + Math.round(100000 * Math.random());
                    window[callbackName] = (data) => {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve(data);
                    };

                    const script = document.createElement('script');
                    script.src = `https://ipapi.co/jsonp?callback=${callbackName}`;
                    script.onerror = reject;
                    document.body.appendChild(script);
                });
            };

            let data = null;
            
            // 1. Attempt Standard Fetch (ipwho.is - CORS friendly usually)
            try {
                let res = await fetchWithTimeout('https://ipwho.is/', 1500);
                if (res.ok) {
                    let rawData = await res.json();
                    if(rawData.success) {
                        data = { 
                            success: true, 
                            ip: rawData.ip, 
                            city: rawData.city, 
                            country: rawData.country, 
                            country_code: rawData.country_code, // e.g., 'SG'
                            latitude: rawData.latitude, 
                            longitude: rawData.longitude 
                        };
                    }
                }
            } catch (e) {}

            // 2. Attempt Backup Fetch (db-ip)
            if (!data) {
                try {
                    let res = await fetchWithTimeout('https://api.db-ip.com/v2/free/self', 1500);
                    if (res.ok) {
                        let rawData = await res.json();
                        // IMPORTANT: db-ip free tier often lacks coords and country_code
                        let coords = { lat: null, lng: null };
                        if(rawData.city) {
                            coords = await geocodeCity(rawData.city, rawData.countryName || "Earth") || coords;
                        }
                        
                        data = { 
                            success: true, 
                            ip: rawData.ipAddress, 
                            city: rawData.city, 
                            country: rawData.countryName, 
                            country_code: "XX", // Fallback, we will check name later
                            latitude: coords.lat, 
                            longitude: coords.lng 
                        };
                    }
                } catch(e) {}
            }

            // 3. NUCLEAR OPTION: JSONP (Bypasses Fetch completely)
            if (!data) {
                try {
                    console.log("Fetch failed. Engaging JSONP...");
                    const rawData = await fetchIpJsonp();
                    if(rawData) {
                        data = { 
                            success: true, 
                            ip: rawData.ip, 
                            city: rawData.city, 
                            country: rawData.country_name, 
                            country_code: rawData.country_code, 
                            latitude: rawData.latitude, 
                            longitude: rawData.longitude 
                        };
                    }
                } catch(e) {
                    console.log("JSONP also failed.");
                }
            }

            // 4. Fallback Construction (Timezone) + Geocoding
            if(!data) {
                const browserLoc = getBrowserLocation(); // returns {city, country}
                let coords = await geocodeCity(browserLoc.city, browserLoc.country) || { lat: null, lng: null };

                data = {
                    success: false,
                    ip: "Encrypted",
                    city: browserLoc.city,
                    country: browserLoc.country,
                    country_code: "XX", 
                    latitude: coords.lat, 
                    longitude: coords.lng
                };
            }

            cachedLocationData = data;
            
            // --- AUTO AI SWITCHING LOGIC (ENHANCED) ---
            // Logic: Switch to Gemini if Country Code is NOT CN/XX OR if Country Name suggests outside China
            const isForeign = (
                (data.country_code && data.country_code !== 'CN' && data.country_code !== 'XX') || 
                (data.country && /Singapore|United States|USA|Japan|Kingdom|Germany|France|Australia|Canada/i.test(data.country))
            );

            if (isForeign) {
                console.log(`Detected Foreign IP (${data.country}). Switching to Gemini.`);
                CONFIG.active = CONFIG.profiles.gemini;
            } else {
                console.log(`Detected Domestic/Unknown IP. Using SiliconFlow (Qwen).`);
                CONFIG.active = CONFIG.profiles.siliconflow;
            }
            updateAIStatusUI();
            
            return data;
        }


        // --- 1. Reliable Globe (Globe.gl) with Hex Bins & Rings ---
        async function initGlobe() {
            if (typeof Globe === 'undefined') {
                document.getElementById('globeViz').innerHTML = '<div style="color:#666;text-align:center;padding:20px;">Earth module loading...</div>';
                return;
            }

            const elem = document.getElementById('globeViz');
            const width = elem.clientWidth || 300;
            const height = elem.clientHeight || 420;

            const world = Globe()
                (elem)
                .width(width).height(height)
                .backgroundColor('rgba(0,0,0,0)')
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
                .atmosphereColor('#2997ff')
                .atmosphereAltitude(0.2);

            // 1. Get User Location (Using robust fetcher)
            const data = await fetchLocationData();
            
            // UI Update
            document.getElementById('user-ip').innerText = data.ip;
            document.getElementById('user-location').innerText = `${data.city}, ${data.country}`;

            // Current User Visualization (Green Pulse)
            const ringsData = [];
            if(data.latitude && data.longitude) {
                ringsData.push({lat: data.latitude, lng: data.longitude, color: '#30d158'});
                
                // Focus camera
                world.pointOfView({ lat: data.latitude, lng: data.longitude, altitude: 1.8 }, 2000);
            }

            // 2. Fetch Historical Visitors (Visualize as Hex Bins)
            if(sb) {
                const { data: dbData } = await sb.from('visitor_logs').select('location, lat, lng').limit(200);
                
                if(dbData && dbData.length > 0) {
                    
                    // --- PATCH: Fix missing coordinates using Client-Side Dictionary ---
                    const validPoints = dbData.map(d => {
                        // If coordinates exist, use them
                        if(d.lat != null && d.lng != null) return d;
                        
                        // If coordinates missing, try to lookup city in dictionary
                        if(d.location) {
                            for (const [city, coords] of Object.entries(CITY_COORDINATES)) {
                                if (d.location.includes(city)) {
                                    return { ...d, lat: coords.lat, lng: coords.lng };
                                }
                            }
                        }
                        return d;
                    }).filter(d => d.lat != null && d.lng != null); // Final filter

                    // A. Use Hex Bins for History (Looks like glowing bars)
                    world.hexBinPointsData(validPoints)
                        .hexBinPointLat(d => d.lat)
                        .hexBinPointLng(d => d.lng)
                        .hexBinResolution(4) // Resolution 4 is decent for city level
                        .hexTopColor(() => '#bf5af2') // Purple Top
                        .hexSideColor(() => 'rgba(191, 90, 242, 0.6)') // Purple Side
                        // üü¢„ÄêUpdate„ÄëÊîπ‰∏∫ÂØπÊï∞ÈÄªËæë (Log Scale) Èò≤Ê≠¢ÂÖâÊü±ËøáÈïø
                        // ÂéüÈÄªËæë: sumWeight * 0.05 + 0.1
                        // Êñ∞ÈÄªËæë: Math.log(sumWeight) * 0.07 + 0.05
                        .hexAltitude(({ sumWeight }) => Math.log(sumWeight) * 0.07 + 0.05); 

                    // B. Also add small points at base for cleaner look
                    // Removed individual points under hex bins to avoid clutter, 
                    // but kept Current User point below.
                }
            }
            
            // Set Rings (Current User Only - to distinguish)
            world.ringsData(ringsData);
            world.ringColor('color');
            world.ringMaxRadius(6);
            world.ringPropagationSpeed(3);
            world.ringRepeatPeriod(800);
            
            // Fallback Auto-rotate if no user location
            if(!data.latitude) {
                world.controls().autoRotate = true;
                world.controls().autoRotateSpeed = 0.6;
            }
        }

        // --- 2. Robust Visitor Logger ---
        async function logVisitor() {
            if (!sb) return; 
            
            try {
                // Reuse the ROBUST data we fetched for the globe
                // This ensures we never fail just because IP failed
                const data = await fetchLocationData(); 
                
                const clientInfo = { 
                    userAgent: navigator.userAgent, 
                    screen: `${window.screen.width}x${window.screen.height}`, 
                    language: navigator.language,
                    renderer: "Client-Side" 
                };
                
                // Safe Insert
                await sb.from('visitor_logs').insert({ 
                    ip: data.ip || 'Unknown', 
                    location: `${data.city}, ${data.country}`, 
                    lat: (data.latitude !== undefined && data.latitude !== null) ? data.latitude : null, 
                    lng: (data.longitude !== undefined && data.longitude !== null) ? data.longitude : null, 
                    device: JSON.stringify(clientInfo) 
                });
                console.log("Visitor logged successfully");
                
            } catch (e) {
                console.log("Visitor log completely failed:", e);
            } 
        }

        // --- 3. Schr√∂dinger's Box ---
        async function openQuantumBox() {
            const resultEl = document.getElementById('quantum-result');
            const iconEl = document.querySelector('.box-icon');
            if (resultEl.innerText !== "Click to observe" && resultEl.innerText !== "ÁÇπÂáªËøõË°åËßÇÊµã") return; 
            resultEl.innerText = currentLang === 'zh' ? "ËßÇÊµã‰∏≠..." : "Observing..."; iconEl.classList.add('open'); 
            
            const prompt = currentLang === 'zh'
                ? "Simulate opening Schr√∂dinger's box. Randomly decide if the cat is Alive or Dead. Then give a very short, deep philosophical sentence about quantum mechanics in Simplified Chinese (ÁÆÄ‰Ωì‰∏≠Êñá). Only return the Chinese sentence."
                : "Simulate opening Schr√∂dinger's box. Randomly decide if the cat is Alive or Dead. Then give a very short, deep philosophical sentence about quantum mechanics in English. Max 20 words.";
            
            const text = await callAI(prompt);
            if (text) { resultEl.innerHTML = text; resultEl.style.opacity = 1; resultEl.style.color = "#bf5af2"; }
        }

        // --- Standard Logic ---
        function initAnimations() {
            gsap.registerPlugin(ScrollTrigger);
            gsap.from(".gsap-hero", { opacity: 0, y: 30, duration: 1, stagger: 0.2, ease: "power3.out" });
            gsap.utils.toArray('.scroll-fade').forEach(el => { gsap.from(el, { scrollTrigger: { trigger: el, start: "top 85%" }, opacity: 0, y: 40, duration: 0.8, ease: "power3.out" }); });
        }
        async function initStats() { try { await sb.rpc('increment_visits', { page_id: 'home_page' }); const { data } = await sb.from('site_stats').select('visits').eq('id', 'home_page').single(); if (data) { const el = document.getElementById('visit-count'); let obj = { val: 0 }; gsap.to(obj, { val: data.visits, duration: 2, ease: "power4.out", onUpdate: () => el.innerText = Math.floor(obj.val).toLocaleString() }); } } catch(e) {} }
        async function loadMessages() { const list = document.getElementById('msg-list'); const { data } = await sb.from('messages').select('*').order('created_at', { ascending: false }).limit(10); if (!data || data.length === 0) { list.innerHTML = `<div style="text-align: center; color: #444;">${i18n[currentLang].no_msg}</div>`; return; } list.innerHTML = data.map(msg => `<div class="msg-bubble">${msg.content.replace(/</g, "&lt;")}<span class="msg-time">${new Date(msg.created_at).toLocaleDateString()}</span></div>`).join(''); }
        async function sendMsg() { if (!sb) { alert('Please configure Supabase Key.'); return; } const input = document.getElementById('msg-input'); const text = input.value.trim(); if(!text) return; const { error } = await sb.from('messages').insert({ content: text }); if (!error) { input.value = ''; loadMessages(); } else { alert(i18n[currentLang].send_fail); } }
        
        // --- ÈÄöÁî® AI Ë∞ÉÁî®ÂáΩÊï∞ (ÊîØÊåÅ Gemini & OpenAI Compatible) + Ëá™Âä®ÊïÖÈöúËΩ¨Áßª ---
        async function callAI(prompt, retry = true) {
            // 1. Á°ÆÂÆöÂΩìÂâç‰ΩøÁî®ÁöÑÈÖçÁΩÆ (Â¶ÇÊûúÊòØÈáçËØïÔºåÂ∞±Áî®Â§áÁî®ÈÖçÁΩÆ)
            let profile = CONFIG.active;
            
            // Â¶ÇÊûúÂ§Ñ‰∫éÈáçËØïÊ®°ÂºèÔºå‰∏îÂΩìÂâçÊòØ GeminiÔºåÂàôÂàáÊç¢Âà∞ SiliconFlowÔºåÂèç‰πã‰∫¶ÁÑ∂
            if (retry === 'backup') {
                profile = (CONFIG.active === CONFIG.profiles.gemini) 
                    ? CONFIG.profiles.siliconflow 
                    : CONFIG.profiles.gemini;
                console.log("Switching to backup profile:", profile.name);
            }

            if (!profile || !profile.key) { console.error("AI Key missing"); return null; }

            try {
                let response, data, resultText;

                // 1. OpenAI Compatible Mode (DeepSeek, Kimi, etc.)
                if (profile.provider === 'openai') {
                    const payload = {
                        model: profile.model,
                        messages: [
                            { role: "system", content: "You are a helpful assistant." },
                            { role: "user", content: prompt }
                        ],
                        stream: false
                    };
                    
                    response = await fetch(profile.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${profile.key}`
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    data = await response.json();
                    resultText = data.choices?.[0]?.message?.content;

                } else {
                    // 2. Default: Google Gemini Mode
                    const geminiUrl = `${profile.url}?key=${profile.key}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    
                    response = await fetch(geminiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    data = await response.json();
                    resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                }

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return resultText;
            } catch (e) {
                console.error(`AI Call Failed (${profile.name}):`, e);
                
                // Ëá™Âä®ÊïÖÈöúËΩ¨ÁßªÈÄªËæë
                if (retry === true) {
                    console.log("Attempting failover to backup provider...");
                    return await callAI(prompt, 'backup');
                }
                return null;
            }
        }

        async function generateAIMessage() {
            const input = document.getElementById('msg-input'); const btn = document.querySelector('.ios-ai-btn'); const originalText = input.value.trim();
            if (!CONFIG.active) { alert("AI API Key not configured."); return; } btn.classList.add('loading');
            let prompt = currentLang === 'zh' ? (originalText ? `ÊîπÂÜôÊõ¥ÊúâÁßëÊäÄÊÑüÔºà‰∏≠ÊñáÔºå30Â≠óÂÜÖÔºâÔºö"${originalText}"` : "ÂÜô‰∏ÄÂè•ÂÖ≥‰∫éÂÆáÂÆôÁöÑÁÆÄÁü≠ÁïôË®ÄÔºà‰∏≠ÊñáÔºâ") : (originalText ? `Rewrite sci-fi style (English): "${originalText}"` : "Write sci-fi message (English)");
            const text = await callAI(prompt); if (text) input.value = text.trim().replace(/^"|"$/g, ''); btn.classList.remove('loading');
        }
        function toggleChat() { document.getElementById('chat-modal').classList.toggle('open'); document.querySelector('.fab-ai').classList.toggle('active'); }
        function toggleFullscreen() { document.getElementById('chat-modal').classList.toggle('fullscreen'); }
        async function sendAIChat() {
            const input = document.getElementById('chat-input'); const body = document.getElementById('chat-body'); const text = input.value.trim();
            if (!text) return; if (!CONFIG.active) { alert("AI API Key not configured."); return; }
            
            // 1. User Message
            body.innerHTML += `<div class="chat-bubble user">${text}</div>`; 
            input.value = ''; 
            body.scrollTop = body.scrollHeight;

            // 2. Thinking Bubble
            const thinkingId = 'thinking-' + Date.now();
            body.innerHTML += `
                <div class="chat-bubble ai" id="${thinkingId}">
                    <div class="thinking-dots"><span></span><span></span><span></span></div>
                </div>`;
            body.scrollTop = body.scrollHeight;

            // 3. AI Request
            // Remove "Quote Li Bai", add "Helpful & Concise"
            const sysPrompt = `You are Tom Shi's AI digital twin. Physics enthusiast, Web Dev. Be helpful, philosophical, and concise. Do not explicitly quote Li Bai unless asked. Lang: ${currentLang}. User: ${text}`;
            const aiText = await callAI(sysPrompt);

            // 4. Remove Thinking & Show Result
            const thinkingEl = document.getElementById(thinkingId);
            if (thinkingEl) thinkingEl.remove();

            body.innerHTML += aiText ? `<div class="chat-bubble ai">${marked.parse(aiText)}</div>` : `<div class="chat-bubble ai">AI Offline.</div>`; 
            body.scrollTop = body.scrollHeight;
        }
    </script>
</body>
</html>
